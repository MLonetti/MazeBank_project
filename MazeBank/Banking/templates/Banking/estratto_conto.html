{% extends "home.html" %}
{% load static %}
{% block head %}
    {{ block.super }}
    <link rel="stylesheet" href="{% static 'css/Banking/estratto_conto.css' %}">
    <link rel="stylesheet" href="{% static 'css/Banking/filtro_transazioni.css' %}">
{% endblock %}
{% block title %}Estratto Conto - MazeBank{% endblock %}
{% block content %}
<div class="container my-5">
    <div class="row justify-content-center">
        <div class="col-lg-14 col-xl-12">
            <div class="card shadow estratto-conto-card p-4">
                <h2 class="mb-4 text-mazebank-red font-weight-bold">Estratto conto</h2>
                <!-- FORM FILTRO -->
                <form id="filtro-transazioni-form" class="mb-4 d-flex flex-wrap align-items-center">
                    <label for="id_campo" class="mr-2 mb-0 font-weight-bold">Filtra per:</label>
                    {{ filtro_form.campo }}
                    {{ filtro_form.valore }}
                </form>
                <div class="table-responsive">
                    <table class="table table-striped table-hover estratto-table">
                        <thead>
                            <tr>
                                <th>Data</th>
                                <th>Tipo</th>
                                <th>Descrizione</th>
                                <th>Importo</th>
                            </tr>
                        </thead>
                        <tbody id="transazioni-tbody">
                            {% for t in transazioni_data %}
                                <tr class="transazione-row">
                                    <td>{{ t.data }}</td>
                                    <td>{{ t.tipo }}</td>
                                    <td>{{ t.descrizione }}</td>
                                    <td class="{{ t.importo_class }}">{{ t.importo }}</td>
                                </tr>
                            {% empty %}
                                <tr>
                                    <td colspan="4" class="text-center">Nessuna transazione trovata.</td>
                                </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal Dettaglio Transazione -->
<div id="transazioneModal" class="estratto-modal" style="display:none;">
    <div class="estratto-modal-content">
        <span class="estratto-modal-close" onclick="closeModal()">&times;</span>
        <h4 id="modal-tipo"></h4>
        <p><strong>Data:</strong> <span id="modal-data"></span></p>
        <p><strong>Importo:</strong> <span id="modal-importo"></span></p>
        <p><strong>Causale:</strong> <span id="modal-causale"></span></p>
        <p><strong>Controparte:</strong> <span id="modal-controparte"></span></p>
        <p><strong>IBAN:</strong> <span id="modal-iban"></span></p>
    </div>
</div>

<div class="estratto-bottone-cc text-center my-4">
    <a href="{% url 'Banking:conto_corrente' user.pk %}" class="btn btn-cc">
        Vai al tuo Conto Corrente
    </a>
</div>

<script>
// --- AJAX FILTRO ---
function aggiornaTabella(transazioni) {
    const tbody = document.getElementById('transazioni-tbody');
    tbody.innerHTML = '';
    if (transazioni.length === 0) {
        tbody.innerHTML = '<tr><td colspan="4" class="text-center">Nessuna transazione trovata.</td></tr>';
        return;
    }
    transazioni.forEach(t => {
        const tr = document.createElement('tr');
        tr.className = "transazione-row";
        tr.innerHTML = `
            <td>${t.data}</td>
            <td>${t.tipo}</td>
            <td>${t.descrizione}</td>
            <td class="${t.importo_class}">${t.importo}</td>
        `;
        // Evento click per aprire il modale
        tr.addEventListener('click', function() {
            document.getElementById('modal-tipo').textContent = t.tipo;
            document.getElementById('modal-data').textContent = t.data;
            document.getElementById('modal-importo').textContent = t.importo;
            document.getElementById('modal-causale').textContent = t.causale || '-';
            document.getElementById('modal-controparte').textContent = t.controparte || '-';
            document.getElementById('modal-iban').textContent = t.iban || '-';
            document.getElementById('transazioneModal').style.display = 'flex';
        });
        tbody.appendChild(tr);
    });
}

document.getElementById('id_campo').addEventListener('change', filtraTransazioni);
document.getElementById('id_valore').addEventListener('input', filtraTransazioni);

function filtraTransazioni() {
    const campo = document.getElementById('id_campo').value;
    const valore = document.getElementById('id_valore').value;
    fetch("{% url 'Banking:ajax_filtra_transazioni' %}?campo=" + campo + "&valore=" + encodeURIComponent(valore))
        .then(response => response.json())
        .then(data => aggiornaTabella(data.transazioni));
}

// --- MODALE DETTAGLIO ---
document.querySelectorAll('.transazione-row').forEach(function(row) {
    row.addEventListener('click', function() {
        document.getElementById('modal-tipo').textContent = this.dataset.tipo;
        document.getElementById('modal-data').textContent = this.dataset.data;
        document.getElementById('modal-importo').textContent = this.dataset.importo;
        document.getElementById('modal-causale').textContent = this.dataset.causale || '-';
        document.getElementById('modal-controparte').textContent = this.dataset.controparte || '-';
        document.getElementById('modal-iban').textContent = this.dataset.iban || '-';
        document.getElementById('transazioneModal').style.display = 'flex';
    });
});
function closeModal() {
    document.getElementById('transazioneModal').style.display = 'none';
}

document.addEventListener('DOMContentLoaded', function() {
    // Aggiungi classi ai campi del filtro
    var campo = document.getElementById('id_campo');
    var valore = document.getElementById('id_valore');
    if (campo) campo.className += ' form-control mr-2 filtro-select filtro-select-small';
    if (valore) valore.className += ' form-control mr-2 filtro-input';

    // Aggiungi evento click alle righe gi√† presenti
    document.querySelectorAll('.transazione-row').forEach(function(row) {
        row.addEventListener('click', function() {
            // Recupera i dati dalle celle
            document.getElementById('modal-tipo').textContent = row.children[1].textContent;
            document.getElementById('modal-data').textContent = row.children[0].textContent;
            document.getElementById('modal-importo').textContent = row.children[3].textContent;
            document.getElementById('modal-causale').textContent = '-';
            document.getElementById('modal-controparte').textContent = '-';
            document.getElementById('modal-iban').textContent = '-';
            document.getElementById('transazioneModal').style.display = 'flex';
        });
    });
});
</script>
{% endblock %}